<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<script src="https://js.tosspayments.com/v1/payment"></script>
<body>
<!-- 상품 상세 페이지 예시 -->
<input type="hidden" id="productId" th:value="${product.id}">
<div>
    <label>상품명 : </label>
    <strong id="productName" th:text="${product.productName}">상품명</strong>
</div>
<div>
    <label>가격 : </label>
    <span id="price" th:text="${product.price}">가격</span>
</div>
<div>
    <label>재고 : </label>
    <span id="stock" th:text="${product.stock}">재고</span>
</div>

<div>
    <label>구매수량</label>
    <input type="number" id="quantity" value="1" min="1">
</div>

<button onclick="startPayment()">결제하기</button>

<div th:if="${errorMessage}">
    <p style="color: red" th:text="${errorMessage}"></p>
</div>

<script>
  async function startPayment() {
      const orderName = document.getElementById("productName").innerText;
      const productId = document.getElementById("productId").value;
      const price = parseInt(document.getElementById("price").innerText);
      const quantity = parseInt(document.getElementById("quantity").value);
      const amount = price * quantity;
      const stock = document.getElementById("stock").innerText;

      if(isNaN(amount) || amount <= 0) {
        alert("올바른 금액이 아닙니다.");
        return;
      }

      if(quantity > stock){
        alert("재고보다 구매수량이 많습니다.")
        return;
      }

      // 1. 서버에 결제 요청 정보 저장 (orderId 생성, Redis 저장 등)
      const res = await fetch("/payment/request", {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify({ productId, orderName, productId, amount, quantity })
      });

      const data = await res.json();

      // 2. Toss SDK로 결제 창 띄우기
      const tossPayments = TossPayments('test_ck_DpexMgkW36N5NAm2MW5M3GbR5ozO');
      tossPayments.requestPayment('카드', {
          productId: data.productId,
          amount: data.amount,
          orderId: data.orderId,
          orderName: data.orderName,
          successUrl: `${data.redirectUrl}`,
          failUrl: `${data.redirectUrl}?orderId=${data.orderId}&fail=true`
      });
  }
</script>

</body>
</html>