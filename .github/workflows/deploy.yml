name: Deploy Spring Boot to EC2

on:
  push:
    branches: [ master ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source code
        uses: actions/checkout@v3

      - name: Set up Java 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Grant execute permission for Gradle
        run: chmod +x ./gradlew

      - name: Decode PEM key for EC2
        run: |
          echo "${{ secrets.EC2_KEY_B64 }}" | base64 -d > ${{ github.workspace }}/homepem.pem
          chmod 600 ${{ github.workspace }}/homepem.pem

      - name: ğŸ³ Install Docker & Docker Compose on EC2
        run: |
          ssh -o StrictHostKeyChecking=no -i ${{ github.workspace }}/homepem.pem ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << EOF
            sudo apt update
            sudo apt install -y apt-transport-https ca-certificates curl software-properties-common gnupg lsb-release
            curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
            echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list
            sudo apt update
            sudo apt install -y docker-ce docker-ce-cli containerd.io
            sudo systemctl start docker
            sudo systemctl enable docker
            sudo curl -SL https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m) -o /usr/local/bin/docker-compose
            sudo chmod +x /usr/local/bin/docker-compose
          EOF

      - name: Clean old JARs
        run: rm -f build/libs/*.jar

      - name: Build Spring Boot application
        run: ./gradlew clean bootJar

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 4) compose / nginx íŒŒì¼ì„ SCP
      - name: Copy compose & nginx config
        run: |
          REMOTE_DIR=/home/ubuntu
          
          ssh -o StrictHostKeyChecking=no -i "${{ github.workspace }}/homepem.pem" \
              "${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}" \
              "mkdir -p /home/ubuntu/blue-green /home/ubuntu/nginx/conf.d"
          
          # docker-compose.bluegreen.yml
          scp -o StrictHostKeyChecking=no -i "${{ github.workspace }}/homepem.pem" \
              deploy/docker-compose.bluegreen.yml \
              "${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:$REMOTE_DIR/blue-green/"
          
          # nginx ì„¤ì •
          scp -o StrictHostKeyChecking=no -i "${{ github.workspace }}/homepem.pem" \
              deploy/nginx/blue-green.conf \
              "${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:$REMOTE_DIR/nginx/conf.d/"

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 5) ìƒˆ JAR â†’ inactive ìƒ‰ ì—…ë¡œë“œ
      - name: Upload JAR
        id: upload
        run: |
          set -eo pipefail
          JAR=$(ls -1 build/libs/*.jar | tail -n1)

           # 1) ì›ê²©ì—ì„œ active ìƒ‰ í™•ì¸ â†’ inactive ìƒ‰ ê³„ì‚°
          COLOR=$(ssh -o StrictHostKeyChecking=no -i "${{ github.workspace }}/homepem.pem" \
          "${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}" "
                docker ps -a --format '{{.Names}}' | grep -q '^spring-blue$' && echo green || echo blue")
          echo "COLOR=$COLOR"
      
          # 2) GitHub-recommended ë°©ì‹ìœ¼ë¡œ output ê¸°ë¡
          echo "color=$COLOR" >> "$GITHUB_OUTPUT"
      
          # 3) ì ˆëŒ€ê²½ë¡œë¡œ ë””ë ‰í„°ë¦¬ ìƒì„±
          REMOTE_BASE="/home/ubuntu"
          ssh -o StrictHostKeyChecking=no -i "${{ github.workspace }}/homepem.pem" \
          "${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}" \
          "mkdir -p ${REMOTE_BASE}/blue-green/spring-${COLOR}"
      
          # 4) JAR íŒŒì¼ ì „ì†¡ (ì ˆëŒ€ê²½ë¡œ ì‚¬ìš©)
          scp -o StrictHostKeyChecking=no -i "${{ github.workspace }}/homepem.pem" \
          "$JAR" \
          "${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:${REMOTE_BASE}/blue-green/spring-${COLOR}/app.jar"
          

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€ 6) Blue-Green ìŠ¤ìœ„ì¹˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Switch containers
        run: |
          COLOR=${{ steps.upload.outputs.color }}
          if [ "$COLOR" = "blue" ]; then OLD=spring-green; else OLD=spring-blue; fi
          
          ssh -o StrictHostKeyChecking=no -i "${{ github.workspace }}/homepem.pem" \
              "${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}" <<EOF     
            set -e
            cd /home/ubuntu/blue-green
          
            # ğŸŒ± í™˜ê²½ë³€ìˆ˜ ì£¼ì…
            export JWT_SECRET='${{ secrets.JWT_SECRET }}'
            export TOSS_SECRET='${{ secrets.TOSS_SECRET }}'
            export TOSS_CLIENT='${{ secrets.TOSS_CLIENT }}'
            export SLACK_WEBHOOK_URL='${{ secrets.SLACK_WEBHOOK_URL }}'
            export AWS_ACCESS_KEY='${{ secrets.AWS_ACCESS_KEY }}'
            export AWS_SECRET_KEY='${{ secrets.AWS_SECRET_KEY }}'
            export AWS_S3_BUCKET='${{ secrets.AWS_S3_BUCKET }}'
            export DB_URL='${{ secrets.DB_URL }}'
            export DB_USERNAME='${{ secrets.DB_USERNAME }}'
            export DB_PASSWORD='${{ secrets.DB_PASSWORD }}'
            export LOGSTASH_HOST='${{ secrets.ELK_HOST }}'
          
            # ìƒˆ ìƒ‰ ì»¨í…Œì´ë„ˆ ê¸°ë™
            docker compose -f docker-compose.bluegreen.yml up -d --no-deps spring-$COLOR
          
            # 120 ì´ˆê¹Œì§€ í—¬ìŠ¤ì²´í¬
            for i in {1..40}; do
              status=\$(docker inspect -f '{{ .State.Health.Status }}' spring-$COLOR || echo starting)
              [ "\$status" = "healthy" ] && break
              sleep 3
            done
            [ "\$status" = "healthy" ] || { echo 'Health FAIL'; exit 1; }
          
            # Nginx reload & êµ¬ë²„ì „ ì¤‘ì§€
            docker compose -f docker-compose.bluegreen.yml exec nginx nginx -s reload
            docker compose -f docker-compose.bluegreen.yml stop $OLD || true
          EOF

      - name: ğŸ›  Install Java on EC2
        run: |
          ssh -o StrictHostKeyChecking=no -i ${{ github.workspace }}/homepem.pem ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << "EOF"
            sudo apt update
            sudo apt install -y openjdk-21-jdk
          EOF

#      - name: Run Spring Boot App on EC2
#        run: |
#          ssh -o StrictHostKeyChecking=no -i ${{ github.workspace }}/homepem.pem ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << EOF
#            echo "ğŸ” ê¸°ì¡´ ì•± ì¢…ë£Œ"
#            pkill -f java || true
#
#            echo "â³ logstash í¬íŠ¸ ì˜¤í”ˆ ëŒ€ê¸°"
#            while ! nc -z localhost 5000; do
#              echo "logstashê°€ ì•„ì§ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ëŒ€ê¸° ì¤‘..."
#              sleep 3
#            done
#
#            echo "ğŸŒ± í™˜ê²½ë³€ìˆ˜ ì„¤ì •"
#            export JWT_SECRET="${{ secrets.JWT_SECRET }}"
#            export TOSS_SECRET="${{ secrets.TOSS_SECRET }}"
#            export TOSS_CLIENT="${{ secrets.TOSS_CLIENT }}"
#            export SLACK_WEBHOOK_URL="${{ secrets.SLACK_WEBHOOK_URL }}"
#            export AWS_ACCESS_KEY="${{ secrets.AWS_ACCESS_KEY }}"
#            export AWS_SECRET_KEY="${{ secrets.AWS_SECRET_KEY }}"
#            export AWS_S3_BUCKET="${{ secrets.AWS_S3_BUCKET }}"
#            export DB_URL="${{ secrets.DB_URL }}"
#            export DB_USERNAME="${{ secrets.DB_USERNAME }}"
#            export DB_PASSWORD="${{ secrets.DB_PASSWORD }}"
#
#            echo "ğŸš€ Spring Boot ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘"
#            nohup java \
#            -Dspring.profiles.active=prod \
#            -jar /home/ubuntu/app.jar \
#            --spring.config.additional-location=file:/home/ubuntu/ \
#            > /home/ubuntu/app.log 2>&1 &
#          EOF

      - name: Slack Notify - ì„±ê³µ
        if: success()
        run: |
          curl -X POST -H 'Content-type: application/json' \
            --data '{"text":"âœ… HealthPower ì„œë²„ ë°°í¬ ì„±ê³µ!"}' \
            ${{ secrets.SLACK_ALERT_WEBHOOK }}

      - name: Slack Notify - ì‹¤íŒ¨
        if: failure()
        run: |
          curl -X POST -H 'Content-type: application/json' \
            --data '{"text":"âŒ HealthPower ì„œë²„ ë°°í¬ ì‹¤íŒ¨! í™•ì¸ í•„ìš”"}' \
            ${{ secrets.SLACK_ALERT_WEBHOOK }}
