<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<script type="text/javascript" src="https://code.jquery.com/jquery-1.12.4.min.js" ></script>
<script src="https://js.tosspayments.com/v1/payment"></script>
<body>
<!-- ìƒí’ˆ ìƒì„¸ í˜ì´ì§€ ì˜ˆì‹œ -->
<input type="hidden" id="productId" th:value="${product.id}">
<div th:replace="fragments/header :: user-status"></div>
<div>
    <label>ìƒí’ˆ ì‚¬ì§„</label>
<!--    <img th:attr="src=${product.imageUrl != null ? product.imageUrl : '/image/default.png'}"-->
<!--         alt="ìƒí’ˆ ì´ë¯¸ì§€" width="150"/>-->
    <img th:src="${product.imageUrl != null} ? ${product.imageUrl} : @{/image/default.png}"
         alt="ìƒí’ˆ ì´ë¯¸ì§€" width="150"/>
</div>
<div>
    <label>ìƒí’ˆëª… : </label>
    <strong id="productName" th:text="${product.productName}">ìƒí’ˆëª…</strong>
</div>
<div>
    <label>ë¶„ë¥˜:</label>
    <span type="text" th:text="${product.category}">ë¶„ë¥˜</span>
</div>
<div>
    <label>ê°€ê²© : </label>
    <span id="price" th:text="${product.price}">ê°€ê²©</span>
</div>
<div>
    <label>ì¬ê³  : </label>
    <span id="stock" th:text="${product.stock}">ì¬ê³ </span>
</div>

<div>
    <label>êµ¬ë§¤ìˆ˜ëŸ‰</label>
    <input type="number" id="quantity" value="1" min="1">
</div>
<div>
    <label>ë‚´ìš©</label>
    <textarea id="content" th:text="${product.content}">ë‚´ìš©</textarea>
</div>

<button onclick="startPayment()">ê²°ì œí•˜ê¸°</button>
<button onclick="iamportPayment()">ê²°ì œí•˜ê¸°(IamPort)</button>

<div th:if="${product.userId == #authentication.principal.userId}">
    <a th:href="@{/board/product/edit/{id}(id=${product.id})}">ìˆ˜ì •</a>
    <form th:action="@{/board/product/delete/{id}(id=${product.id})}" method="post">
        <button type="submit">ì‚­ì œ</button>
    </form>
</div>

<div>
    <label>ì‚¬ìš©í•  ì¿ í°</label>
    <select id="couponIssuanceId">
        <option value="">ì„ íƒ ì•ˆ í•¨</option>
        <option th:each="couponIssuance : ${availableCoupons}"
                th:if="${couponIssuance != null and couponIssuance.coupon != null}"
                th:value="${couponIssuance.id}"
                th:attr="data-discount=${couponIssuance.coupon.amount}"
                th:text="|[${couponIssuance.coupon.name}] ${couponIssuance.coupon.amount}ì› í• ì¸|">
        </option>
    </select>
</div>

<!-- ëŒ“ê¸€ ë¦¬ìŠ¤íŠ¸ -->
<h3>ëŒ“ê¸€</h3>
<div th:if="${#lists.isEmpty(comments)}">
    <p>ì•„ì§ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</p>
</div>

<div th:each="comment : ${comments}" class="comment-box"
     style="display: flex; align-items: center; margin-bottom: 12px;">
    <img th:src="${comment.imageUrl != null ? comment.imageUrl : 'https://via.placeholder.com/42'}"
         style="width: 42px; height: 42px; border-radius: 50%; margin-right: 12px;" alt="í”„ë¡œí•„">
    <div>
        <strong th:text="${comment.nickname}">ë‹‰ë„¤ì„</strong>:
        <span th:text="${comment.content}">ëŒ“ê¸€ ë‚´ìš©</span>
        <!-- ë³¸ì¸ë§Œ ì‚­ì œ ë²„íŠ¼ ë³´ì´ê¸° -->
        <form th:if="${comment.userId == #authentication.principal.userId}"
              th:action="@{'/comment/' + ${comment.commentId} + '/delete'}"
              method="post" style="display:inline;">
            <button type="submit">ì‚­ì œ</button>
        </form>
    </div>
</div>

<!-- ëŒ“ê¸€ ì‘ì„± í¼ -->
<!-- ë¡œê·¸ì¸ ì‚¬ìš©ìì—ê²Œë§Œ ë³´ì—¬ì§€ëŠ” ì˜ì—­ -->
<div sec:authorize="isAuthenticated()">
    <form th:action="@{/comment}" method="post">
        <input type="hidden" name="productId" th:value="${product.id}"/>
        <textarea name="content" rows="3" cols="50" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”" required></textarea>
        <br>
        <button type="submit">ëŒ“ê¸€ ë“±ë¡</button>
    </form>
</div>

<!-- ë¹„ë¡œê·¸ì¸ ì‚¬ìš©ìì—ê²Œ ì•ˆë‚´ -->
<div sec:authorize="isAnonymous()">
    <p>ëŒ“ê¸€ì„ ì‘ì„±í•˜ë ¤ë©´ <a th:href="@{/members/login}">ë¡œê·¸ì¸</a>ì´ í•„ìš”í•©ë‹ˆë‹¤.</p>
</div>

<div th:if="${errorMessage}">
    <p style="color: red" th:text="${errorMessage}"></p>
</div>

<div>
    <button onclick="productList()">ìƒí’ˆ ëª©ë¡</button>
</div>

<script>

    function productList() {
        location.href = "/board/product";
    }
    async function startPayment() {
        const orderName = document.getElementById("productName").innerText;
        const productId = document.getElementById("productId").value;
        const price = parseInt(document.getElementById("price").innerText);
        const quantity = parseInt(document.getElementById("quantity").value);
        const stock = parseInt(document.getElementById("stock").innerText);

        //ì¿ í° ì •ë³´
        const selectedCoupon = document.getElementById("couponIssuanceId");
        const couponIssuanceId = selectedCoupon.value;
        const discountAmount = couponIssuanceId ? parseInt(selectedCoupon.options[selectedCoupon.selectedIndex].dataset.discount) : 0;

        const amount = price * quantity - discountAmount;

        console.log(discountAmount);

        if(isNaN(amount) || amount <= 0) {
          alert("ìƒí’ˆ ê°€ê²©ì´ ì¿ í° í• ì¸ ê°€ê²©ë³´ë‹¤ ë‚®ì„ ìˆ˜ëŠ” ì—†ìŠµë‹ˆë‹¤.");
          return;
        }

        if(quantity > stock){
          alert("ì¬ê³ ë³´ë‹¤ êµ¬ë§¤ìˆ˜ëŸ‰ì´ ë§ìŠµë‹ˆë‹¤.")
          return;
        }

        // 1. ì„œë²„ì— ê²°ì œ ìš”ì²­ ì •ë³´ ì €ì¥ (orderId ìƒì„±, Redis ì €ì¥ ë“±)
        const res = await fetch("/payment/request", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({ productId, orderName, amount, quantity })
        });

        const data = await res.json();

        // 2. Toss SDKë¡œ ê²°ì œ ì°½ ë„ìš°ê¸°
        const tossPayments = TossPayments('test_ck_DpexMgkW36N5NAm2MW5M3GbR5ozO');
        tossPayments.requestPayment('ì¹´ë“œ', {
            productId: data.productId,
            amount: data.amount,
            orderId: data.orderId,
            orderName: data.orderName,
            //successUrl: `${data.redirectUrl}`,
            //failUrl: `${data.redirectUrl}?orderId=${data.orderId}&fail=true`
            successUrl: `${data.redirectUrl}/success`,
            failUrl: `${data.redirectUrl}/fail?message=ì‹¤íŒ¨&orderId=${data.orderId}&fail=true`
        });
    }

    async function iamportPayment() {
        const IMP = window.IMP;
        const price = parseInt(document.getElementById("price").innerText);
        const orderName = document.getElementById("productName").innerText;
        const productId = document.getElementById("productId").value;
        const quantity = parseInt(document.getElementById("quantity").value);
        const stock = parseInt(document.getElementById("stock").innerText);

        //ì¿ í° ì •ë³´
        const selectedCoupon = document.getElementById("couponIssuanceId");
        const couponIssuanceId = selectedCoupon.value;
        const discountAmount = couponIssuanceId ? parseInt(selectedCoupon.options[selectedCoupon.selectedIndex].dataset.discount) : 0;

        const amount = price * quantity - discountAmount;

        console.log(discountAmount);

        if(isNaN(amount) || amount <= 0) {
          alert("ìƒí’ˆ ê°€ê²©ì´ ì¿ í° í• ì¸ ê°€ê²©ë³´ë‹¤ ë‚®ì„ ìˆ˜ëŠ” ì—†ìŠµë‹ˆë‹¤.");
          return;
        }

        if(quantity > stock){
          alert("ì¬ê³ ë³´ë‹¤ êµ¬ë§¤ìˆ˜ëŸ‰ì´ ë§ìŠµë‹ˆë‹¤.")
          return;
        }

        if(!IMP){
            alert("ì•„ì„í¬íŠ¸ ìŠ¤í¬ë¦½íŠ¸ ë¡œë”© ì‹¤íŒ¨: window.IMPê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
            return;
        }

        IMP.init("imp78118502");

        const orderRes = await fetch("/impPayment", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            productId: productId,
            quantity: quantity,
            orderName: orderName,
            price: price,
            stock: stock,
            amount: amount,
            couponIssuanceId: couponIssuanceId,
          }),
        });

        const { merchantUid } = await orderRes.json();

        console.log("ğŸŸ¢ merchant_uid length:", merchantUid.length);
        console.log("ğŸŸ¢ merchant_uid:", merchantUid);

        IMP.request_pay(
          {
            pg: "uplus",
            pay_method: "card",
            merchant_uid: merchantUid,
            name: orderName,
            amount: amount,
            buyer_email: "test@example.com",
            buyer_name: "í™ê¸¸ë™",
            buyer_tel: "010-1234-5678",
            buyer_addr: "ì„œìš¸ì‹œ ê°•ë‚¨êµ¬",
          },
          async function (rsp) {
            if (rsp.success) {
              // 3. ê²°ì œ ê²€ì¦ ìš”ì²­
              const verifyRes = await fetch("/impPayment/verify", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  impUid: rsp.imp_uid,
                  merchantUid: rsp.merchant_uid,
                }),
              });

              if (verifyRes.ok) {
                alert("âœ… ê²°ì œ ì™„ë£Œ! ì£¼ë¬¸ì´ ì •ìƒì ìœ¼ë¡œ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.");
                location.href = "/board/product";
              } else {
                alert("âš ï¸ ê²°ì œëŠ” ë˜ì—ˆì§€ë§Œ ê²€ì¦ ì‹¤íŒ¨! ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.");
              }
            } else {
              alert("âŒ ê²°ì œ ì‹¤íŒ¨: " + rsp.error_msg);
            }
          }
        );
      }

<!--    function requestPay(){-->
<!--        IMP.request_pay(-->
<!--            {-->
<!--                pg: "tosspayments",-->
<!--                pay_method: "card",-->
<!--                merchant_uid: "order_1234",-->
<!--                name: data.orderName,-->
<!--                amount: data.amount,-->
<!--                buyer_email: "oksktmddjs@gmail.com",-->
<!--                buyer_name: "í™ê¸¸ë™",-->
<!--                buyer_tel: "010-1234-5678",-->
<!--                buyer_addr: "ì„œìš¸íŠ¹ë³„ì‹œ ê°•ë‚¨êµ¬",-->
<!--            },-->
<!--    function (rsp) {-->
<!--        if (rsp.success) {-->
<!--            fetch("/impPayment/verify", {-->
<!--                method: "POST",-->
<!--                headers: { "Content-Type": "application/json" },-->
<!--                body: JSON.stringify({-->
<!--                    imp_uid: rsp.imp_uid,-->
<!--                    merchant_uid: rsp.merchant_uid,-->
<!--                }),-->
<!--            });-->
<!--        } else {-->
<!--            alert("ê²°ì œ ì‹¤íŒ¨ : " + rsp.error_msg);-->
<!--        }-->
<!--    }-->
<!--);-->
<!--}-->
</script>
<script type="text/javascript" src="https://cdn.iamport.kr/js/iamport.payment-1.1.5.js"></script>
</body>
</html>